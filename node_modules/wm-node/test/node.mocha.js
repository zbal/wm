var should = require('should');
var fs = require('fs');
var path = require('path');

require('./fixture');

var bonesTest = require('bones-test');
var server = bonesTest.server();

// Test config.
var config = server.plugin.config;
config.stash = path.resolve(require.resolve('./fixture'), '../');

// Test data.
var data = {
    ip: '8.8.8.8',
    public_key: 'aaa'
};

describe('Node', function() {
    // Model.
    bonesTest.testModel(server, 'Node');

    // CRUD.
    bonesTest.testModelCRUD(server, 'Node', data, {
        status: 'disabled'
    });
    bonesTest.testModelCRUDHTTP(server, 'Node', data, {
        status: 'disabled'
    });

    var model = server.plugin.models['Node'];

    // Validate.
    describe('Validate', function() {
        it('should return nothing with the right data', function(done) {
            should.not.exist(new model().validate(data));
            setTimeout(done, 1);
        });

        it('should return the error with missing IP', function(done) {
            var error = new model().validate({});
            error.should.be.a('object');
            error.should.have.property('message', 'IP is required');
            setTimeout(done, 1);
        });

        it('should return the error with invalid IP', function(done) {
            var error = new model().validate({
                ip: 'bad.ip.format.123'
            });
            error.should.be.a('object');
            error.should.have.property('message', 'Invalid IP format');
            setTimeout(done, 1);
        });
    });
    
    // custom functions
    describe('Custom functions', function() {
        var testModel = new model(data);
    
        it('should create the created_date and modified_date as equal', function(done) {
            testModel.setDefaults();
            testModel.get('created_date').should.be.a('number');
            testModel.save(null, {
                success: function(_model, res) {
                    _model.get('modified_date').should.equal(_model.get('created_date'));
                    setTimeout(done, 1);
                },
                error: function(_model, err) {
                    should.fail('Expecting no error');
                    setTimeout(done, 1);
                }
            });
        });
        
        it('should update the modified date on save', function(done) {
            testModel.save({status: 'disabled'}, {
                success: function(_model, res) {
                    _model.get('modified_date').should.be.a('number');
                    _model.get('modified_date').should.not.equal(_model.get('created_date'));
                    setTimeout(done, 1);
                },
                error: function(_model, err) {
                    should.fail('Expecting no error');
                    setTimeout(done, 1);
                }
            });
        });
        
        it('should set the geoip info', function(done) {
            testModel.setGeoSync({
                success: function() {
                    testModel.get('continent_code').should.be.a('string');
                    testModel.get('country_code').should.be.a('string');
                    setTimeout(done, 1);
                },
                error: function(err) {
                    should.fail('No error expected');
                    setTimeout(done, 1);
                }
            });
        });

        it('should save the modified GeoIP on save', function(done) {
            testModel.save({status: 'enabled'}, {
                success: function(_model, res) {
                    setTimeout(done, 1);
                },
                error: function(_model, err) {
                    should.fail('Expecting no error');
                    setTimeout(done, 1);
                }
            });
        });
        
        it('should destroy the testModel', function(done) {
            testModel.destroy({
                success: function() {
                    setTimeout(done, 1);
                },
                error: function() {
                    should.fail('Expecting no error');
                    setTimeout(done, 1);
                }
            });
        });
    });

    // Cleanup.
    describe('Remove the lorem stash', function() {
        it('should return no error', function(done) {
            fs.rmdir(path.resolve(config.stash, 'nodes'), function(err) {
                should.not.exist(err);
                setTimeout(done, 1);
            });
        });
    });
});
